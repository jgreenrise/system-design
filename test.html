<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensuring Exactly-Once Guarantee in Payment Systems</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 20px;
        }

        h1, h2, h3 {
            color: #333;
        }

        p {
            color: #555;
        }
    </style>
</head>
<body>

<article>

    <h1>Ensuring Exactly-Once Guarantee in Payment Systems</h1>

    <p>One of the most serious problems the payment system can have is to double charge a customer. It is important to guarantee in our design that the payment system executes a payment order exactly once.</p>

    <p><strong>Mathematically, an operation is executed exactly once if:</strong></p>
    <ul>
        <li>1. It is executed at least once.</li>
        <li>At the same time, it is executed at most once.</li>
    </ul>

    <h2>1. AT-LEAST-ONCE Use Retry</h2>

    <p>Occasionally, we need to retry a payment transaction due to network errors or timeouts. Retry provides at least once guarantee, deciding the appropriate time intervals between retries is important.</p>
    <p>Here are a few common retry strategies: Immediate retry, fixed intervals, increment intervals, exponential backoff, etc. As a general guideline, use exponential backoff if the network issue is unlikely to be resolved in a short amount of time.</p>
    <p>Overly aggressive retry strategies waste computing resources and can cause service overload.</p>

    <h2>2. AT-MOST-ONCE Use Idempotency in Header</h2>

    <p>A potential problem of retrying is double payments. To avoid double payment, the payment has to be executed at most once. This is also called idempotency.</p>

    <p><strong>HTTP header:</strong></p>
    <code>&lt;idempotency-key&gt;:&lt;idempotency-value&gt;</code>

    <p>Idempotency is key to ensuring the at-most once guarantee. For communication between clients and servers, an idempotency key is usually a unique value that is generated by the client and expires after a certain period of time.</p>
    <p>UUID is used as an idempotency key and is recommended by various payment companies. To perform an idempotent payment request, an idempotency key is added to the HTTP header.</p>
    <p>When the user clicks pay, an idempotency key is sent to the payment system as part of the HTTP request. In an e-commerce website, the idempotency key is usually the ID of the shopping cart right before the checkout.</p>

    <h3>Scenario: What if the customer clicks the pay button twice quickly?</h3>
    <p>1. If a customer clicks the pay button twice quickly, the idempotency key generated by the client (usually based on the shopping cart ID) will be sent with both requests. The PSP, recognizing the idempotency key, will check the status of the previous request.</p>
    <p>2. If the payment is still in progress or has already been successfully processed, the PSP will return the latest status to the user. This ensures that even if the user attempts to pay multiple times quickly, the system handles it gracefully without causing double charges.</p>
    <p>3. To support idempotency, we can use the database's unique key constraint</p>

    <h3>Scenario: Response fails to reach payment service from PSP due to network errors. User clicks on pay button again</h3>
    <p>1. When the user clicks on the pay button, the payment order is same. So the token sent to the PSP is the same. Because the token is used as the idempotency key on the PSP side, it is able to identify the double payment and return the status of previosu execution.</p>






</article>

</body>
</html>
